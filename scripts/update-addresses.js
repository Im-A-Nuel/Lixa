#!/usr/bin/env node
/**
 * Update frontend/src/lib/contracts/addresses.ts from the latest Forge broadcast.
 *
 * Usage:
 *   node scripts/update-addresses.js [chainId]
 *
 * Defaults to chainId 31337 (anvil). Expects broadcast/Deploy.s.sol/<chainId>/run-latest.json.
 */
const fs = require("fs");
const path = require("path");

const chainId = process.argv[2] || "31337";
const broadcastPath = path.join(
  __dirname,
  "..",
  "broadcast",
  "Deploy.s.sol",
  chainId,
  "run-latest.json"
);

if (!fs.existsSync(broadcastPath)) {
  console.error(`Broadcast file not found: ${broadcastPath}`);
  process.exit(1);
}

/** @type {any} */
const run = JSON.parse(fs.readFileSync(broadcastPath, "utf8"));
const txs = Array.isArray(run.transactions) ? run.transactions : [];

const required = [
  "AssetNFT",
  "AssetRegistry",
  "Fractionalizer",
  "LicenseNFT",
  "LicenseManager",
  "SecondaryMarket",
];

/** Collect contractName -> address from CREATE txs */
const addrMap = {};
for (const tx of txs) {
  if (tx.transactionType !== "CREATE") continue;
  if (tx.contractName && tx.contractAddress) {
    addrMap[tx.contractName] = tx.contractAddress;
  }
}

const missing = required.filter((name) => !addrMap[name]);
if (missing.length) {
  console.error(`Missing addresses in broadcast for: ${missing.join(", ")}`);
  process.exit(1);
}

const addressesTsPath = path.join(
  __dirname,
  "..",
  "frontend",
  "src",
  "lib",
  "contracts",
  "addresses.ts"
);

const nextContent = `// Auto-generated by scripts/update-addresses.js; do not edit manually.
export const CONTRACT_ADDRESSES = {
  ${chainId}: {
    AssetNFT: "${addrMap.AssetNFT}",
    AssetRegistry: "${addrMap.AssetRegistry}",
    Fractionalizer: "${addrMap.Fractionalizer}",
    LicenseNFT: "${addrMap.LicenseNFT}",
    LicenseManager: "${addrMap.LicenseManager}",
    SecondaryMarket: "${addrMap.SecondaryMarket}",
  },
  // Add other chains (e.g., Sepolia 11155111) manually or by extending this script.
} as const;

export type SupportedChainId = keyof typeof CONTRACT_ADDRESSES;

export function getContractAddress(
  chainId: number,
  contract: keyof (typeof CONTRACT_ADDRESSES)[${chainId}]
): \`0x\${string}\` | undefined {
  const addresses = CONTRACT_ADDRESSES[chainId as SupportedChainId];
  if (!addresses) return undefined;
  const addr = addresses[contract];
  return addr ? (addr as \`0x\${string}\`) : undefined;
}
`;

fs.writeFileSync(addressesTsPath, nextContent);
console.log(`Updated ${addressesTsPath} from ${broadcastPath}`);
console.log("Addresses:");
console.table(
  required.map((name) => ({
    contract: name,
    address: addrMap[name],
  }))
);
